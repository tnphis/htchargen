(function(c){"function"===typeof define&&define.amd?define(["underscore","backbone","exports"],c):"object"===typeof exports?c(require("underscore"),require("backbone"),exports):c(_,Backbone,{})})(function(c,l,n){l.Stickit=n;n._handlers=[];n.addHandler=function(b){b=c.map(c.flatten([b]),function(a){return c.defaults({},a,{updateModel:!0,updateView:!0,updateMethod:"text"})});this._handlers=this._handlers.concat(b)};n.ViewMixin={_modelBindings:null,unstickit:function(b,a){if(c.isObject(a))c.each(a,function(a,
c){this.unstickit(b,c)},this);else{var d=[],f=[];this._modelBindings=c.reject(this._modelBindings,function(c){if(!b||c.model===b)if(!a||c.config.selector==a)return c.model.off(c.event,c.fn),f.push(c.config._destroy),d.push(c.model),!0});c.invoke(c.uniq(d),"trigger","stickit:unstuck",this.cid);c.each(c.uniq(f),function(a){a.call(this)},this);this.$el.off(".stickit"+(b?"."+b.cid:""),a)}},stickit:function(b,a){var d=b||this.model,f=a||c.result(this,"bindings")||{};this._modelBindings||(this._modelBindings=
[]);this.addBinding(d,f);var h=this.remove;h.stickitWrapped||(this.remove=function(){var a=this;this.unstickit();h&&(a=h.apply(this,arguments));return a});this.remove.stickitWrapped=!0;return this},addBinding:function(b,a,d){var f=b||this.model,h=".stickit."+f.cid;d=d||{};if(c.isObject(a))c.each(a,function(a,b){this.addBinding(f,b,a)},this);else{var g=":el"===a?this.$el:this.$(a);this.unstickit(f,a);if(g.length){c.isString(d)&&(d={observe:d});c.isFunction(d.observe)&&(d.observe=d.observe.call(this));
var e=C(g,d),m=e.observe;e.selector=a;e.view=this;var y=e.bindId=c.uniqueId(),p=c.extend({stickitChange:e},e.setOptions);e._destroy=function(){k.call(this,e.destroy,g,f,e)};D(g,e,f,m);E(g,e,f,m);F(g,e,f,m);m&&(c.each(e.events,function(b){this.$el.on(b+h,":el"===a?"":a,c.bind(function(a){var b=k.call(this,e.getVal,g,a,e,w.call(arguments,1));x(e.updateModel,b,a,e)&&G(f,m,b,p,e)},this))},this),c.each(c.flatten([m]),function(a){r(f,"change:"+a,e,function(a,b,c){(c&&c.stickitChange&&c.stickitChange.bindId)!==
y&&(a=t(f,m,e),B(g,e,a,f))})}),b=t(f,m,e),B(g,e,b,f,!0));k.call(this,e.initialize,g,f,e)}}}};c.extend(l.View.prototype,n.ViewMixin);var w=[].slice,u=function(b,a){var d=(a||"").split("."),d=c.reduce(d,function(a,b){return a[b]},b);return null==d?b:d},k=function(b){if(b=c.isString(b)?u(this,b):b)return b.apply(this,w.call(arguments,1))},x=function(b,a,d){if(c.isBoolean(b))return b;if(c.isFunction(b)||c.isString(b)){var f=c.last(arguments).view;return k.apply(f,arguments)}return!1},r=function(b,a,c,
f){var h=c.view;b.on(a,f,h);h._modelBindings.push({model:b,event:a,fn:f,config:c})},G=function(b,a,d,f,h){var g={},e=h.view;h.onSet&&(d=k.call(e,h.onSet,d,h));h.set?k.call(e,h.set,a,d,f,h):(g[a]=d,c.isArray(a)&&c.isArray(d)&&(g=c.reduce(a,function(a,b,e){a[b]=c.has(d,e)?d[e]:null;return a},{})),b.set(g,f))},t=function(b,a,d){var f=d.view,h=function(a){return b[d.escape?"escape":"get"](a)},g=function(a){return null==a?"":a};a=c.isArray(a)?c.map(a,h):h(a);d.onGet&&(a=k.call(f,d.onGet,a,d));return c.isArray(a)?
c.map(a,g):g(a)},C=n.getConfiguration=function(b,a){var d=[{updateModel:!1,updateMethod:"text",update:function(a,b,c,d){if(a[d.updateMethod])a[d.updateMethod](b)},getVal:function(a,b,c){return a[c.updateMethod]()}}],d=d.concat(c.filter(n._handlers,function(a){return b.is(a.selector)}));d.push(a);d=c.extend.apply(c,d);c.has(d,"updateView")||(d.updateView=!d.visible);return d},D=function(b,a,d,f){var h="autofocus autoplay async checked controls defer disabled hidden indeterminate loop multiple open readonly required scoped selected".split(" "),
g=a.view;c.each(a.attributes||[],function(e){e=c.clone(e);e.view=g;var m="",y=e.observe||(e.observe=f),k=function(){var a=c.contains(h,e.name)?"prop":"attr",g=t(d,y,e);if("class"===e.name)b.removeClass(m).addClass(g),m=g;else b[a](e.name,g)};c.each(c.flatten([y]),function(b){r(d,"change:"+b,a,k)});k()})},F=function(b,a,d,f){c.each(a.classes||[],function(h,g){c.isString(h)&&(h={observe:h});h.view=a.view;var e=h.observe,f=function(){var a=t(d,e,h);b.toggleClass(g,!!a)};c.each(c.flatten([e]),function(b){r(d,
"change:"+b,a,f)});f()})},E=function(b,a,d,f){if(null!=a.visible){var h=a.view,g=function(){var e=a.visible,g=a.visibleFn,l=t(d,f,a),p=!!l;if(c.isFunction(e)||c.isString(e))p=!!k.call(h,e,l,a);g?k.call(h,g,b,p,a):b.toggle(p)};c.each(c.flatten([f]),function(b){r(d,"change:"+b,a,g)});g()}},B=function(b,a,c,f,h){var g=a.view;x(a.updateView,c,a)&&(k.call(g,a.update,b,c,f,a),h||k.call(g,a.afterUpdate,b,c,a))};n.addHandler([{selector:"[contenteditable]",updateMethod:"html",events:["input","change"]},{selector:"input",
events:["propertychange","input","change"],update:function(b,a){b.val(a)},getVal:function(b){return b.val()}},{selector:"textarea",events:["propertychange","input","change"],update:function(b,a){b.val(a)},getVal:function(b){return b.val()}},{selector:'input[type="radio"]',events:["change"],update:function(b,a){b.filter('[value="'+a+'"]').prop("checked",!0)},getVal:function(b){return b.filter(":checked").val()}},{selector:'input[type="checkbox"]',events:["change"],update:function(b,a,d,f){1<b.length?
(a||(a=[]),b.each(function(b,d){var e=l.$(d),f=c.contains(a,e.val());e.prop("checked",f)})):(d=c.isBoolean(a)?a:a===b.val(),b.prop("checked",d))},getVal:function(b){var a;if(1<b.length)a=c.reduce(b,function(a,b){var c=l.$(b);c.prop("checked")&&a.push(c.val());return a},[]);else{a=b.prop("checked");var d=b.val();"on"!==d&&null!=d&&(a=a?b.val():null)}return a}},{selector:"select",events:["change"],update:function(b,a,d,f){var h,g=f.selectOptions,e=g&&g.collection||void 0,m=b.prop("multiple");if(!g){var g=
{},n=function(a){return a.map(function(a,b){var c=l.$(b).data("stickit-bind-val");return{value:void 0!==c?c:b.value,label:b.text}}).get()};b.find("optgroup").length?(e={opt_labels:[]},b.find("> option").length&&(e.opt_labels.push(void 0),c.each(b.find("> option"),function(a){e[void 0]=n(l.$(a))})),c.each(b.find("optgroup"),function(a){var b=l.$(a).attr("label");e.opt_labels.push(b);e[b]=n(l.$(a).find("option"))})):e=n(b.find("option"))}g.valuePath=g.valuePath||"value";g.labelPath=g.labelPath||"label";
g.disabledPath=g.disabledPath||"disabled";var p=function(a,b,d){c.each(a,function(a){var e=l.$("<option/>"),f=a,h,k;"__default__"===a?(h=d.label,k=d.value,a=d.disabled):(h=u(a,g.labelPath),k=u(a,g.valuePath),a=u(a,g.disabledPath));(function(a,b,d){e.text(a);f=b;e.data("stickit-bind-val",f);c.isArray(f)||c.isObject(f)||e.val(f);!0===d&&e.prop("disabled","disabled")})(h,k,a);!m&&null!=f&&null!=d&&f===d||c.isObject(d)&&c.isEqual(f,d)?e.prop("selected",!0):m&&c.isArray(d)&&c.each(d,function(a){c.isObject(a)&&
(a=u(a,g.valuePath));(a===f||c.isObject(a)&&c.isEqual(f,a))&&e.prop("selected",!0)});b.append(e)})};b.find("*").remove();if(c.isString(e)){var q=window;0===e.indexOf("this.")&&(q=this);e=e.replace(/^[a-z]*\.(.+)$/,"$1");h=u(q,e)}else h=c.isFunction(e)?k.call(this,e,b,f):e;if(h instanceof l.Collection){var v=h,r=function(){var a=t(d,f.observe,f);k.call(this,f.update,b,a,d,f)},w=function(){v.off("add remove reset sort",r)},x=function(){w();v.off("stickit:selectRefresh");d.off("stickit:selectRefresh")};
v.trigger("stickit:selectRefresh");v.once("stickit:selectRefresh",w,this);v.on("add remove reset sort",r,this);d.trigger("stickit:selectRefresh");d.once("stickit:selectRefresh",function(){d.off("stickit:unstuck",x)});d.once("stickit:unstuck",x,this);h=h.toJSON()}g.defaultOption&&(q=c.isFunction(g.defaultOption)?g.defaultOption.call(this,b,f):g.defaultOption,p(["__default__"],b,q));if(c.isArray(h))p(h,b,a);else if(h.opt_labels)c.each(h.opt_labels,function(c){var d=l.$("<optgroup/>").attr("label",c);
p(h[c],d,a);b.append(d)});else{var q=[],z,A;for(A in h)z={},z[g.valuePath]=A,z[g.labelPath]=h[A],q.push(z);q=c.sortBy(q,g.comparator||g.labelPath);p(q,b,a)}},getVal:function(b){var a=b.find("option:selected");return b.prop("multiple")?c.map(a,function(a){return l.$(a).data("stickit-bind-val")}):a.data("stickit-bind-val")}}]);return n});
