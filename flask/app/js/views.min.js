define(["jquery","underscore","backbone","models.min","collections.min"],function(d,g,e,n,q){var l={DataTableView:e.View.extend({initialize:function(a){this.options=a||{}},tagName:"div",events:{"click #dt_btn_refresh":"refresh"},render:function(){var a=this;require(["datatables","text","text!"+Global.config.staticdir+"/templates/datatable.html"],function(b,c,p){Global.templates.datatable||(Global.templates.datatable=g.template(p));a.template=Global.templates.datatable;a.options.dtsettings={};a.options.per_page_options=
[{id:10,text:10},{id:15,text:15},{id:20,text:20},{id:25,text:25},{id:30,text:30},{id:35,text:35},{id:50,text:50},{id:75,text:75},{id:100,text:100},{id:200,text:200}];a.options.sInfo=a.getsInfo();b={sDom:"Trt",oTableTools:{aButtons:[]},bStateSave:!0,oLanguage:{sZeroRecords:"..."},fnDrawCallback:function(b){a.options.datatable&&(a.options.dtsettings=a.options.datatable.fnSettings(),a.data_was_loaded&&(a.options.sInfo=a.getsInfo()),a.options.customDrawCallback&&a.options.customDrawCallback(b))}};a.$el.html(a.template(a.options));
a.options.datatable||(a.options.datatable=a.$el.find("#maintable").dataTable(d.extend(b,a.options.datatableparams)));if(a.options.additional_buttons)for(b=0,c=a.options.additional_buttons.length;b<c;b++){var f=a.options.additional_buttons[b];console.log(f);f.click&&(a.$el.find("#dt_additional_btn_"+f.id).unbind("click"),a.$el.find("#dt_additional_btn_"+f.id).bind("click",function(b){f.click(b,a)}))}return a})},getsInfo:function(){return this.options.dtsettings&&0<this.options.dtsettings._iDisplayEnd?
"Displaying entries "+(this.options.dtsettings._iDisplayStart+1)+" to "+this.options.dtsettings._iDisplayEnd+" out of "+this.options.fnRecordsDisplay():"No data to display"},refresh:function(){this.options.beforerefresh&&this.options.beforerefresh();this.options.sInfo="Loading data...";this.options.disablePrevPage=!0;this.options.disableNextPage=!0;var a=this;this.options.collection.fetch({success:function(b,c,d){a.redraw();a.data_was_loaded=!0;a.options.sInfo=a.getsInfo();a.options.afterrefresh&&
a.options.afterrefresh()}})},redraw:function(){var a=this;require(["datatables"],function(){var b=a.options.collection.map(function(b){for(var d=[],f=0,e=a.options.datatableparams.aoColumns.length;f<e;f++){var h=a.options.datatableparams.aoColumns[f];console.log(h);console.log(b);d.push(b.get(h.collection_id))}console.log(d);return d});a.options.datatable.fnClearTable();0<b.length&&a.options.datatable.fnAddData(b)})}}),SkillBarView:e.View.extend({initialize:function(a){this.options=a||{};void 0===
this.options.cap&&(this.options.cap=this.options.max)},tagName:"span",events:{"click #btn_increase":"increase_value","click #btn_decrease":"decrease_value"},drawboxes:function(){for(var a=this.$el.find("#"+this.options.id+"_boxes"),b="",c=0;c<this.options.value;c++)b+="&rtrif;";for(c=0;c<this.options.cap-this.options.value;c++)b+="&rtri;";for(c=0;c<this.options.max-this.options.cap;c++)b+='<span class="skillbar-grayed">&rtri;</span>';a.html(b);this.options.value>=this.options.cap?this.$el.find("#btn_increase").attr("disabled",
"true"):this.$el.find("#btn_increase").removeAttr("disabled");this.options.value<=this.options.min?this.$el.find("#btn_decrease").attr("disabled","true"):this.$el.find("#btn_decrease").removeAttr("disabled")},render:function(){var a=this;require(["text","text!"+Global.config.staticdir+"/templates/skillbar.html"],function(b,c){Global.templates.skillbar||(Global.templates.skillbar=g.template(c));a.template=Global.templates.skillbar;a.$el.html(a.template(a.options));a.inputel=a.$el.find("input");a.inputel.val(a.options.value);
a.drawboxes();a.options.afterdraw&&a.options.afterdraw(a)})},increase_value:function(){this.options.value<this.options.cap&&(this.options.value+=1,this.drawboxes(),this.inputel.val(this.options.value),this.inputel.trigger("change"))},decrease_value:function(){this.options.value>this.options.min&&(--this.options.value,this.drawboxes(),this.inputel.val(this.options.value),this.inputel.trigger("change"))}}),NavbarView:e.View.extend({tagName:"div",initialize:function(a){this.options=a||{}},events:{"click #MenuLogout":function(){confirm("Confirm user logout")&&
d.ajax({url:"/auth?logout=true",method:"get",dataType:"json",success:function(a){a.success?(Global.user={},e.history.navigate("app/client/login",{trigger:!0})):alert("Something happened...")},error:function(){alert("Something happened...")}})},"click #MenuChangepasswd":function(){this.$el.find("#PasswdChangeModalForm").modal("show")},"keyup #old_passwd":"validate_form","keyup #new_passwd":"validate_form","keyup #confirm_passwd":"validate_form","click #BtnChangePasswdRequest":function(){var a=this.$el.find("#old_passwd").val(),
b=this.$el.find("#new_passwd").val(),c=this.$el.find("#confirm_passwd").val();b==c?d.ajax({url:"/auth?change_passwd=true&old_passwd="+a+"&new_passwd="+b,method:"get",dataType:"json",success:function(a){a.success?(alert("Password changed successfully"),this.$el.find("#BtnChangePasswdRequest").modal("hide")):alert("Error: "+a.error_desc)},error:function(){alert("Unhandled server error")}}):alert("The new password doesn't match its confirmation value.")}},validate_form:function(){this.$el.find("#old_passwd").val()&&
this.$el.find("#new_passwd").val()&&this.$el.find("#confirm_passwd").val()?this.$el.find("#BtnChangePasswdRequest").removeAttr("disabled"):this.$el.find("BtnChangePasswdRequest").attr("disabled","true")},render:function(){var a=this;require(["text","text!"+Global.config.staticdir+"/templates/navbar.html"],function(b,c){a.$el.html(c);a.options.page_name?a.$el.find("#CurrentPageName").html(a.options.page_name):a.$el.find("#CurrentPageName").html("Random unnamed page");a.$el.find("#CurrentUserName").html(Global.user.name);
console.log(Global.user.name);return a})}}),LoginView:e.View.extend({tagName:"div",events:{"click #btn_login":"login_user","click #btn_register":"register_user","keyup input":"check_button_status"},render:function(){var a=this;require(["text","text!"+Global.config.staticdir+"/templates/login.html"],function(b,c){a.$el.html(c);a.check_button_status()})},check_button_status:function(a){var b=this;require(["utils"],function(c){var d=b.$el.find("#login").val(),f=b.$el.find("#passwd").val(),e=b.$el.find("#reglogin").val(),
h=b.$el.find("#regemail").val(),k=b.$el.find("#btn_login"),m=b.$el.find("#btn_register");d&&f?(k.removeAttr("disabled"),13==a.which&&b.login_user()):k.attr("disabled","true");e&&c.validate_email(h)?(m.removeAttr("disabled"),13==a.which&&b.register_user()):m.attr("disabled","true")})},login_user:function(){var a=this.$el.find("#login").val(),b=this.$el.find("#passwd").val();d.ajax({url:"/auth?login=true&user_name="+a+"&user_passwd="+b,method:"get",dataType:"json",success:function(a){a.success?(Global.user.id=
a.user_id,e.history.navigate("client/characters",{trigger:!0})):alert("Login unsuccessful...")}})},register_user:function(){var a=this.$el.find("#reglogin").val(),b=this.$el.find("#regemail").val();d.ajax({url:"/auth?register=true&user_name="+a+"&user_email="+b,method:"get",dataType:"json",success:function(a){a.success?(d("#RegistrationFormTitle").html("Registration successful"),d("#RegistrationFormContent").html("Your new password is <b>"+a.passwd+"</b>")):(d("#RegistrationFormTitle").html("Registration unsuccessful"),
a.error_desc?d("#RegistrationFormContent").html(a.error_desc):d("#RegistrationFormContent").html("Unknown error"));d("#RegistrationModalForm").modal("show")}})}}),CharactersListView:e.View.extend({initialize:function(a){this.options=a||{};var b=this;require(["collections.min"],function(a){a=new a.CharactersList;b.characters_table=new l.DataTableView({collection:a,datatableparams:{aoColumns:[{sTitle:"Name",sWidth:"150px",collection_id:"name"},{sTitle:"Level",sWidth:"50px",collection_id:"level"},{sTitle:"Gender",
sWidth:"75px",collection_id:"gender"},{sTitle:"Race",sWidth:"75px",collection_id:"race"},{sTitle:"Background",sWidth:"75px",collection_id:"social_background"},{sTitle:"Wealth",sWidth:"75px",collection_id:"wealth"},{sTitle:"Points",sWidth:"50px",collection_id:"point_pool"},{sTitle:"",collection_id:"id",sWidth:"30px"}],fnRowCallback:function(a,c,g,h){d(a).click(function(){e.history.navigate("client/edit_character/"+c[7],{trigger:!0})}).css({cursor:"pointer"}).addClass("chargenapp-list-row");d(a).find("td:eq(7)").html("").append(d("<button>").addClass("chargenapp-btn").html("-").attr("title",
"Delete this character").click(function(a){a.stopPropagation();confirm("Confirm the utter and irreversible destruction of "+c[0])&&b.characters_table.options.collection.get(c[7]).destroy({success:function(a,c){c.success?alert("Character destroyed"):alert("Error: "+c.error_desc);b.characters_table.refresh()},error:function(a,c){alert("Unhandled server error!");b.characters_table.refresh()}})}))}},additional_buttons:[{id:"add",html:'<i class="glyphicon glyphicon-plus"></i>',"class":"btn btn-primary",
title:"Add",click:function(a,b){e.history.navigate("client/edit_character/-1",{trigger:!0})}}]})})},tagName:"div",events:{},render:function(){var a=this;require(["text","text!"+Global.config.staticdir+"/templates/characters_list.html"],function(b,c){a.$el.html(c);console.log(a);a.characters_table.render();a.characters_table.refresh();a.$el.find("#char_view_datatable").html(a.characters_table.el)})}}),CharacterView:e.View.extend({initialize:function(a){this.options=a||{};console.log("prolly true",
Global.settings.objects);if(Global.settings.objects||Global.char_settings_event_set)this.options.select_options=Global.settings.objects,this.options.skill_groups=Global.settings.client.skill_groups,this.options.feat_types=Global.settings.client.feat_types;else{var b=this;d(window).on("settings_loaded",function(){b.options.select_options=Global.settings.objects;console.log("wtf is wrong with the settings",Global.settings);b.options.skill_groups=Global.settings.client.skill_groups;b.options.feat_types=
Global.settings.client.feat_types});Global.char_settings_event_set=!0}b=this;require(["backbone_stickit","jqform"],function(){b.options.model=(new n.Character({id:b.options.character_id})).on("sync",function(a){b.model_just_synced=!0;b.options.model_backup=a.clone();console.log("sync",b.options.model_backup);b.render(function(){b.$el.find("#btn_cancel").attr("disabled",!0);b.$el.find("#btn_save").attr("disabled",!0);b.$el.find("#char_name_placeholder").removeClass("hidden").addClass(b.options.get_name_class("placeholder"));
b.$el.find("#real_char_name").removeClass("hidden").addClass(b.options.get_name_class("real_name"));if(-1!=a.id)for(var d=0,e=b.options.model_backup.get("attributes").length;d<e;d++){var g=b.options.model_backup.get("attributes")[d];b.$el.find("#attribute_"+d).attr("min",g.value)}})}).on("change",function(a){b.model_just_synced&&(console.log("removing disabled"),b.$el.find("#btn_cancel").removeAttr("disabled"),b.$el.find("#btn_save").removeAttr("disabled"),b.options.model.get("level")==Global.settings.level_cap&&
b.$el.find("#btn_levelup").attr("disabled",!0),b.model_just_synced=!1)}).on("custom_error",function(a){b.render();a?alert("Error: "+a):alert("Unknown error")});b.options.get_name_class=function(a){return"real_name"==a&&!b.options.model.get("name")||"placeholder"==a&&b.options.model.get("name")?"hidden":""};console.log("model initialized")})},tagName:"div",events:{"change .bound_attr":function(a){var b=Number(d(a.target).attr("id").substr(10)),c=d.extend(!0,[],this.options.model.get("attributes"));
c[b].value=d(a.target).val();this.options.model.set("attributes",c);this.drawskills()},"click #char_name_placeholder":function(a){d(a.target).addClass("hidden");this.$el.find("#char_name_input").removeClass("hidden").focus()},"click #real_char_name":function(a){d(a.target).addClass("hidden");this.$el.find("#char_name_input").removeClass("hidden").focus()},"click #btn_go_back":function(){e.history.navigate("client/characters",{trigger:!0})},"click #btn_delete":function(){confirm("Confirm the utter and irreversible destruction of "+
this.options.model.get("name"))&&this.options.model.destroy({success:function(a,b){b.success?(alert("Character destroyed. Redirecting the characters list."),e.history.navigate("client/characters",{trigger:!0})):alert("Error: "+b.error_desc)},error:function(a,b){alert("Unhandled server error!")}})},"blur #char_name_input":function(a){d(a.target).addClass("hidden");this.$el.find("#char_name_placeholder").removeClass("hidden").addClass(this.options.get_name_class("placeholder"));this.$el.find("#real_char_name").removeClass("hidden").addClass(this.options.get_name_class("real_name")).html(this.options.model.get("name"));
console.log(this.options.get_name_class("placeholder"),this.options.get_name_class("real_name"))},"click #btn_refresh":function(){this.options.model.fetch()},"click #btn_cancel":function(){console.log("btn_cancel clicked");console.log("cancel",this.options.model_backup);this.options.model_backup&&(this.options.model=this.options.model_backup.clone());var a=this;this.render(function(){a.$el.find("#btn_cancel").attr("disabled",!0);a.$el.find("#btn_save").attr("disabled",!0);a.model_just_synced=!0})},
"click #btn_save":function(){this.options.model.isValid()?(console.log("model is valid!"),this.options.model.save(this.options.model.attributes,{success:function(a,b){b.success?e.history.navigate("client/edit_character/"+b.data.id,{trigger:!0}):alert("Error: "+b.error_desc)},error:function(a,b){alert("Unhandled server error!")}})):alert("Required fields not filled: "+this.options.model.validationError.join(", "))},"click #btn_create":function(){this.model_just_synced?e.history.navigate("client/edit_character/-1",
{trigger:!0}):confirm("Confirm creating a new character. Any changes you have made will be lost")&&e.history.navigate("client/edit_character/-1",{trigger:!0})},"click #btn_levelup":function(){if(-1==this.options.model.id)alert("The character doesn't exist it! Save before leveling up.");else{var a="Confirm level up. The procedure is irreversible.";this.model_just_synced||(a+=" Any unsaved changes you have made will be lost.");if(confirm(a)){var b=this;d.ajax({url:"/api?levelup=true&character_id="+
this.options.model.id,method:"post",dataType:"json",success:function(a){a.success?(b.options.model.fetch(),console.log(b.options.model.get("level"))):alert("Error: "+a.error_desc)},error:function(){alert("Unhandled server error")}})}}},"mouseover #PortraitPanel":function(a){d(a.target).find("#PortraitForm").removeClass("hidden");d(a.target).find("#BtnDeletePortrait").removeClass("hidden");d(a.target).find("img").addClass("chargenapp-portrait-sm")},"mouseleave #PortraitPanel":function(a){d(a.target).find("#PortraitForm").addClass("hidden");
d(a.target).find("#BtnDeletePortrait").addClass("hidden");d(a.target).find("img").removeClass("chargenapp-portrait-sm")},"click #BtnSelectFile":function(){this.$el.find("#portrait_file").trigger("click")},"change #portrait_file":function(a){this.$el.find("#portrait_file_placeholder").val(d(a.target).val())},"click #BtnPortraitFormSubmit":function(){console.log(this.portrait_form);this.portrait_form.submit()},"click #BtnDeletePortrait":function(){confirm("Confirm removal of the character's portrait")&&
(console.log("lalalalala"),console.log(this.portrait_form),this.portrait_form.clearForm(),this.portrait_form.submit())}},bindings:{"#points":"points","#wealth":"wealth","#level":"level","#char_name_input":"name","#race":{observe:"race",selectOptions:{collection:"this.options.select_options.races",labelPath:"name",valuePath:"id",defaultOption:{label:"",value:null}}},"#gender":{observe:"gender",selectOptions:{collection:"this.options.select_options.genders",labelPath:"value",valuePath:"id",defaultOption:{label:"",
value:null}}},"#social_background":{observe:"social_background",selectOptions:{collection:"this.options.select_options.social_backgrounds",labelPath:"value",valuePath:"id",defaultOption:{label:"",value:null}}}},refresh:function(){var a=this;require(["models.min","backbone_stickit","jqform"],function(){a.options.model.fetch()})},render:function(a){var b=this;require(["text","text!"+Global.config.staticdir+"/templates/character_view.html"],function(c,d){Global.templates.character_view||(Global.templates.character_view=
g.template(d));b.template=Global.templates.character_view;b.$el.html(b.template(b.options));b.stickit(b.options.model);b.drawskills();b.portrait_form=b.$el.find("#PortraitForm").ajaxForm({iframe:!0,dataType:"json",type:"POST",url:"/api?upload_portrait=true&character_id="+b.options.character_id,success:function(a){a.success?b.options.model.fetch():alert("Error: "+a.error_desc)},error:function(){alert("Unhandled server error!")}});a&&a();console.log("view rendered");return b})},drawskills:function(){var a=
this;g.each(g.keys(a.options.model.get("skills")),function(b){g.each(a.options.model.get("skills")[b],function(c,e){var f=new l.SkillBarView({id:"skill_"+c.id,min:0,max:6,cap:a.options.model.get_skill_cap(c),value:c.value,afterdraw:function(g){a.$el.find("#skill_bar_"+c.id).html(f.el);var h=a.options.model.get_attr_requirements(c);h&&""!=h&&(a.$el.find("#skill_bar_"+c.id).attr("title"," "),a.$el.find("#skill_bar_"+c.id).attr("data-title",h));var k=g.$el.find("input");k.on("change",function(){var c=
d.extend(!0,{},a.options.model.get("skills"));c[b][e].value=Number(k.val());a.options.model.set("skills",c)})}});f.render()})})}})};return l});
