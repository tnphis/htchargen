define(["jquery","underscore","backbone"],function(m,h,l){return{Character:l.Model.extend({initialize:function(){console.log("char model initialized",Global.settings,this.id);this.on("change:skills",function(a,c){var b=a.previous("skills");if(b){for(var d=Number(a.get("points")),d=Number(d),e=0,f=Global.settings.client.skill_groups.length;e<f;e++)for(var g=Global.settings.client.skill_groups[e],k=0,h=c[g].length;k<h;k++)c[g][k].value!=b[g][k].value&&(d-=(c[g][k].value-b[g][k].value)*Global.settings.skill_cost);
0<=d?a.set("points",d):(a.set("skills",b),this.trigger("custom_error",["Not enough points!"]))}});this.on("change:attributes",function(a,c){var b=a.previous("attributes");if(b){for(var d=Number(a.get("points")),d=Number(d),e=0,f=c.length;e<f;e++)c[e].value!=b[e].value&&(d-=(c[e].value-b[e].value)*Global.settings.attribute_cost);0<=d?a.set("points",d):(a.set("attributes",b),this.trigger("custom_error",["Not enough points!"]))}});this.on("change:social_background",function(a,c){a.previous("social_background")&&
!c&&a.set("social_background",a.previous("social_background"));var b=h.find(Global.settings.objects.social_backgrounds,function(a){return a.id==c});if(b){var d;d=a.previous("social_background")?h.find(Global.settings.objects.social_backgrounds,function(b){return b.id==a.previous("social_background")}):-1==a.get("id")?h.find(Global.settings.objects.social_backgrounds,function(a){return 0==a.point_cost}):b;console.log(Global.settings.objects.social_backgrounds,b,d,c);d=a.get("points")-b.point_cost+
d.point_cost;0<=d?(a.set("points",d),a.set("wealth",b.starting_wealth)):(a.set("social_background",a.previous("social_background")),this.trigger("custom_error",["Not enough points!"]))}})},url:function(){return"/api?get_character=true&character_id="+this.id},parse:function(a,c){console.log("parsing",a);a.success||alert("Error: "+a.error_desc);return a.data},validate:function(a,c){var b=[];a.name.length||b.push("Name");a.race||b.push("Race");a.gender||b.push("Gender");a.social_background||b.push("Social background");
if(0<b.length)return b},get_skill_cap_by_type:function(a,c){var b,d,e,f;"primary"==c?(d=h.find(this.get("attributes"),function(b){return b.code==a.primary_attribute}),b=Global.settings.skill_attr_cap_threshold_primary,f=Global.settings.skill_attr_cap_per_lvl_primary,e=Global.settings.skill_attr_cap_primary):"secondary"==c&&(d=h.find(this.get("attributes"),function(b){return b.code==a.secondary_attribute}),b=Global.settings.skill_attr_cap_threshold_secondary,f=Global.settings.skill_attr_cap_per_lvl_secondary,
e=Global.settings.skill_attr_cap_secondary);return b-1+Math.ceil((d.value-e+1)/f)},get_skill_cap:function(a){var c=this.get_skill_cap_by_type(a,"primary");a=this.get_skill_cap_by_type(a,"secondary");return Math.min(c,a)},get_attr_requirements:function(a){if(6==a.value)return null;var c="",b=h.find(this.get("attributes"),function(b){return b.code==a.primary_attribute}),d=h.find(this.get("attributes"),function(b){return b.code==a.secondary_attribute}),e=this.get_skill_cap(a)+1,f=0;e>=Global.settings.skill_attr_cap_threshold_primary&&
(f=Number(Global.settings.skill_attr_cap_primary)+(e-Global.settings.skill_attr_cap_threshold_primary)*Global.settings.skill_attr_cap_per_lvl_primary);var g=0;e>=Global.settings.skill_attr_cap_threshold_secondary&&(g=Number(Global.settings.skill_attr_cap_secondary)+(e-Global.settings.skill_attr_cap_threshold_secondary)*Global.settings.skill_attr_cap_per_lvl_secondary);f>b.value&&(c+="Minimum "+a.primary_attribute+" required: "+f);g>d.value&&(f>b.value&&(c+="\n"),c+="Minimum "+a.secondary_attribute+
" required: "+g);"Leadership"==a.name&&console.log(e,f,g,a,b,d);return""==c?null:c}}),CharacterListItem:l.Model.extend({})}});
